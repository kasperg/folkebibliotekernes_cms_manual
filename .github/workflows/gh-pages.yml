name: Deploy Jekyll site to GitHub Pages

on:
  push:
    branches: ["*"]

env:
  REPO_NAME: 'folkebibliotekernes_cms_manual'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Get branch names
        id: branch-name
        uses: tj-actions/branch-names@v7
      - name: Set GitHub Pages directory
        id: github-pages
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "::set-output name=directory::main"
            echo "::set-output name=url::https://${{ github.repository_owner }}.github.io/folkebibliotekernes_cms_manual/main"
          else
            echo "::set-output name=directory::preview/${{ steps.branch-name.outputs.current_branch }}"
            echo "::set-output name=url::https://${{ github.repository_owner }}.github.io/folkebibliotekernes_cms_manual/preview/${{ steps.branch-name.outputs.current_branch }}"
          fi
      - name: Set Jekyll base url
        uses: fjogeleit/yaml-update-action@main
        with:
          valueFile: '_config.yml'
          propertyPath: 'baseurl'
          value: '/folkebibliotekernes_cms_manual/${{ steps.github-pages.outputs.directory }}'
          commitChange: false
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v3
      - name: Build
        uses: actions/jekyll-build-pages@v1
        with:
          destination: ./build
      - name: Start deployment
        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: ${{ steps.branch-name.outputs.current_branch }}
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./build
          destination_dir: ${{ steps.github-pages.outputs.directory }}
          enable_jekyll: false
      - name: Update deployment status
        uses: bobheadxi/deployments@v1
        if: always()
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
          env: ${{ steps.deployment.outputs.env }}
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env_url: ${{ steps.github-pages.outputs.url }}
